#cloud-config
# Cloud-init configuration for NVIDIA Air BCM deployment
# This configures passwords, SSH keys, and access for automation
#
# INSTRUCTIONS:
# 1. The deploy script auto-generates cloud-init-password.yaml from this template
# 2. SSH_PUBLIC_KEY from .env is used to replace YOUR_SSH_PUBLIC_KEY_HERE
# 3. The {PASSWORD} placeholder is replaced at runtime by the script

# Change passwords for existing users (new format to avoid deprecation warnings)
chpasswd:
  users:
    - name: root
      password: "{PASSWORD}"
      type: text
    - name: ubuntu
      password: "{PASSWORD}"
      type: text
  expire: false

# Allow password authentication for SSH (as fallback)
ssh_pwauth: true

# Add SSH key to default user (ubuntu)
ssh_authorized_keys:
  - YOUR_SSH_PUBLIC_KEY_HERE

# Enable root SSH login, bring up all interfaces, and configure SSH
runcmd:
  # Setup root SSH access
  - mkdir -p /root/.ssh
  - chmod 700 /root/.ssh
  - echo "YOUR_SSH_PUBLIC_KEY_HERE" >> /root/.ssh/authorized_keys
  - chmod 600 /root/.ssh/authorized_keys
  - sed -i 's/^#*PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
  - systemctl restart sshd
  # Bring up all ethernet interfaces with link-local (APIPA) addressing
  # This ensures the outbound interface is up regardless of which eth* it is
  - |
    for iface in /sys/class/net/eth*; do
      ifname=$(basename $iface)
      ip link set $ifname up
      # Wait briefly for link-local address assignment
      sleep 1
    done
  - echo "Cloud-init: All interfaces brought up, root SSH enabled"
